(function(b,f){f=f||{};f.FormValidator=function(c){c.use("Mustache","mustache");var a=c.context_prototype.prototype.mustache,d={MESSAGES:{maxlength:"Too long",minlength:"Too short",required:"This field is required",pattern:"Not a valid "},validateField:function(e){var a=this,g=b(e),c=["required","maxlength","pattern"];g.hasClass("input-error")||!g.hasClass("input-valid")?b.each(c,function(e){g.data("h5-"+c[e])&&a.Messenger.appendErrorMessage(c[e],g)}):g.hasClass("input-valid")&&d.Messenger.hideInputError(g)}};
d.Messenger={formMessage:function(e,c,d){b(e).find(".submit-error, .submit-success").remove().end().find("input[type=submit]").after(a(c,d))},appendErrorMessage:function(e,a){var b=a.val().toLowerCase();switch(e){case "maxlength":if(b.length>a.attr("maxlength"))return this.showInputError(a,d.MESSAGES.maxlength),!1;break;case "required":if(b.length===0)return this.showInputError(a,d.MESSAGES.required),!1;break;case "pattern":if(a.data("h5-pattern").test(b.toLowerCase())===!1)return a.hasClass("h5-minLength")?
this.showInputError(a,d.MESSAGES.minlength):a.hasClass("h5-email")?this.showInputError(a,d.MESSAGES.pattern+"email"):this.showInputError(a,d.MESSAGES.pattern+"URL"),!1;else a.removeClass("input-error")}},showInputError:function(e,b){var c=a('<div class="error-msg">{{msg}}</div>',{msg:b});e.prev(".error-msg").length!==0?this.hideInputError(e).before(c):e.before(c)},hideInputError:function(a){return a.prev(".error-msg").remove().end()}};d.Submitter={processSubmission:function(a,c,g,h){b(c).remove(".submit-error, .submit-success");
a?(d.Messenger.formMessage(c,g,h),this.clearForm(b(c))):d.Messenger.formMessage(c,g,h)},clearForm:function(a){a.find("input:not([type=submit]), textarea").val("")}};this.helpers({validate:function(a){d.validateField(a)},successfulSubmission:function(a,b,c){d.Submitter.processSubmission(!0,a,b,c)},unSuccessfulSubmission:function(a,b,c){d.Submitter.processSubmission(!1,a,b,c)},clearForm:function(a){d.Submitter.clearForm(b(a))}})}})(jQuery,window.Sammy);
(function(b,f){f=f||{};f.Paginator=function(b,a){a||(a="paginate");b.helper(a,function(a,b){var c=this;return this.send(a,b).then(function(a){var d;d=a.rows.length==b.limit?a.rows.pop():{key:null,id:null};c.pagination(b.reference,{nextKey:d.key,nextKeyID:d.id});d=[];var f=b.reference,i=b.limit;if(f.nextIndex)i+=f.nextIndex-1,d=a.rows[0].value.slice(f.nextIndex,i);else for(f=0;f<a.rows.length;f+=1)d.push(a.rows[f].value);return{rows:d}})})}})(jQuery,window.Sammy);
(function(b){var f=b.sammy("body",function(){this.use("Mustache","ms").use("Couch","underground-git").use("FormValidator").use("Paginator","paginate");this.raise_errors=!0;this.debug=!1;this.helpers({hideLoader:function(c){b(c).find(".loader").remove();return this},onHomepage:function(){return!/(articles|screencasts|scripts|about)$/.test(document.location.pathname)},loadBlurbs:function(c,a,d){var e=this.db.name,f={descending:!0,type:a.replace(/^\.|#/g,""),success:function(c){b(a).append(c.body).data("last-key",
c.key);Hyphenator.run()}};b.extend(d,f);b.couch.db(e).list(e+"/blurbs",c,d);this.hideLoader(a);return this},validateInputs:function(c,a,d){var e=this;if(c.lol1||c.lol2)throw Error("Nice try.");b(".input-valid").length<3?(b.each([".h5-url",".h5-minLength","textarea"],function(a,b){e.validate(b)}),c={msg:"Sorry, your submission didn't go through. Make sure you have filled in all inputs correctly and try again.",submitClass:"submit-error"},e.unSuccessfulSubmission(a,'<p class="{{submitClass}} hyphenate">{{msg}}</p>',
c)):d()}});this.get("#/",function(){this.onHomepage()&&(this.loadBlurbs("script_fragment","#scripts",{limit:12,rows:4,cols:3,heading:"Latest Script Activity"}),this.loadBlurbs("latest_screencasts","#screencasts",{limit:6,rows:3,cols:2,trlen:28,heading:"Latest Screencasts"}));/scripts$/.test(document.location.pathname)&&this.loadBlurbs("by_rating","#by-rating",{limit:14,rows:7,cols:2,heading:"Popular Scripts"})});this.post("#/new",function(b){b.validateInputs(b.params,b.target,function(){b.send(Article.processNewDoc,
b.params,b.target)})});this.post("#/contact",function(c){var a=c.target,d;b.ajax({type:"POST",url:"/mail",data:{sender:c.params.name,email:c.params.email,subject:"Vim Underground Inquiry",message:c.params.message},dataType:"json",success:function(){d="Message sent! Thank you for your inquiry!";c.successfulSubmission(a,'<p class="{{klass}}">{{{msg}}}</p>',{klass:"submit-success",msg:d})},error:function(){d='Sorry, but your email could not be sent. You can try again or use your <a href="mailto:your@email.com">email client</a> to send the message.';
c.unSuccessfulSubmission(a,'<p class="{{klass}}">{{{msg}}}</p>',{klass:"submit-error",msg:d})}})});this.bind("show-hide-header",function(b,a){var d=a.$parent,e=a.$menu,f=parseInt(d.css("top"))<0?0:-50;d.animate({top:f},"fast",function(){e.hasClass("up")?e.removeClass("up").addClass("down"):e.hasClass("down")&&e.removeClass("down").addClass("up")})});this.bind("show-more",function(b,a){var d=a.selector,e=a.options,f=e.view,g=a.parent.data("last-key");e={limit:e.limit||15,rows:e.rows||3,cols:e.cols||
5,startkey:typeof g==="string"?g.split(",",2):g,skip:1};this.loadBlurbs(f,d,e)});this.bind("add-article",function(b,a){var d=this,e=a.target,f=a.doc,g=f.type,h;Article.save(f,{success:function(){h=g.capitalize()+" successfully submitted! It will appear alongside other "+g.pluralize()+" after being reviewed.";d.successfulSubmission(e,'<p class="{{klass}}">{{msg}}</p>',{klass:"submit-success",msg:h})},error:function(a,b,c){h=/Document update conflict/.test(c)?(g==="article"?"An ":"A ")+g+" with the same URL already exists.":
g.capitalize()+" not created! Please make sure you havefilled out all input fields and that they're valid before trying again. If the problem persists, feel free to contact me.";d.unSuccessfulSubmission(e,'<p class="{{klass}}">{{msg}}</p>',{klass:"submit-error",msg:h})}})});this.bind("load-validation",function(c,a){var d=b(a.form);b.h5Validate.addPatterns({minLength:/^(\w.*){5,}$/,url:RegExp("(https?|ftps?)\\://(((?:(?:[\\da-zA-Z](?:[-\\da-zA-Z]{0,61}[\\da-zA-Z])?)\\.)+(?:[a-zA-Z](?:[-\\da-zA-Z]{0,6}[\\da-zA-Z])?)\\.?))(\\:\\d+)?(/(?:[^?#\\s/]+/)*(?:[^?#\\s/]+(?:\\?[^?#\\s/]*)?(?:#[A-Za-z][\\w.:-]*)?)?)?")});
d.h5Validate({kbSelectors:"[name=title], [type=url], [type=email], [name=name], textarea",keyup:!0,errorClass:"input-error",validClass:"input-valid",debug:!1}).bind("submit",function(a){a.preventDefault()})});this.bind("run",function(){var c=this;b("#menu-link a","header").bind("click",function(a){a.preventDefault();c.trigger("show-hide-header",{$parent:b(this).parents("header"),$menu:b(this)})});c.trigger("load-validation",{form:"form"});b(".submit").live("click",function(a){a.preventDefault();a=
b("#menu-link a");b(".overlay").fadeIn("fast");b(this).parents("header").length>0&&c.trigger("show-hide-header",{$parent:a.parents("header"),$menu:a})});b("input:not([type=submit]), textarea",b(this).parent("form")[0]).live("keydown",function(){c.validate(this)});b(".close").live("click",function(a){a.preventDefault();b(".overlay").fadeOut("fast")});b(".more").live("click",function(a){if(!c.onHomepage()){a.preventDefault();a=b(this).parent("section");var d,e;d="#"+a.attr("id");mappings={articles:{view:"latest_articles"},
"t-screencasts":{view:"latest_screencasts"},"t-scripts":{view:"script_fragment",limit:21,rows:7,cols:3},"by-rating":{view:"by_rating",limit:14,rows:7,cols:2}};e=mappings[d.replace("#","")];b(this).remove();c.trigger("show-more",{parent:a,selector:d,view:void 0,options:e})}})})});b(function(){f.run("#/")})})(jQuery);Article=Sammy("body").createModel("article");
Article.extend({getScreenCastRegex:function(){return/http:\/\/(.*youtube\.com\/watch.*|.*\.youtube\.com\/v\/.*|youtu\.be\/.*|.*\.youtube\.com\/user\/.*|.*\.youtube\.com\/.*#.*\/.*|m\.youtube\.com\/watch.*|m\.youtube\.com\/index.*|.*\.youtube\.com\/profile.*|.*justin\.tv\/.*|.*justin\.tv\/.*\/b\/.*|.*justin\.tv\/.*\/w\/.*|www\.ustream\.tv\/recorded\/.*|www\.ustream\.tv\/channel\/.*|www\.ustream\.tv\/.*|qik\.com\/video\/.*|qik\.com\/.*|qik\.ly\/.*|.*revision3\.com\/.*|.*\.dailymotion\.com\/video\/.*|.*\.dailymotion\.com\/.*\/video\/.*|www\.collegehumor\.com\/video:.*|.*twitvid\.com\/.*|www\.break\.com\/.*\/.*|vids\.myspace\.com\/index\.cfm\?fuseaction=vids\.individual&videoid.*|www\.myspace\.com\/index\.cfm\?fuseaction=.*&videoid.*|www\.metacafe\.com\/watch\/.*|www\.metacafe\.com\/w\/.*|blip\.tv\/file\/.*|.*\.blip\.tv\/file\/.*|video\.google\.com\/videoplay\?.*|.*revver\.com\/video\/.*|video\.yahoo\.com\/watch\/.*\/.*|video\.yahoo\.com\/network\/.*|.*viddler\.com\/explore\/.*\/videos\/.*|liveleak\.com\/view\?.*|www\.liveleak\.com\/view\?.*|animoto\.com\/play\/.*|dotsub\.com\/view\/.*|www\.overstream\.net\/view\.php\?oid=.*|www\.livestream\.com\/.*|www\.worldstarhiphop\.com\/videos\/video.*\.php\?v=.*|worldstarhiphop\.com\/videos\/video.*\.php\?v=.*|teachertube\.com\/viewVideo\.php.*|www\.teachertube\.com\/viewVideo\.php.*|www1\.teachertube\.com\/viewVideo\.php.*|www2\.teachertube\.com\/viewVideo\.php.*|bambuser\.com\/v\/.*|bambuser\.com\/channel\/.*|bambuser\.com\/channel\/.*\/broadcast\/.*|www\.schooltube\.com\/video\/.*\/.*|bigthink\.com\/ideas\/.*|bigthink\.com\/series\/.*|sendables\.jibjab\.com\/view\/.*|sendables\.jibjab\.com\/originals\/.*|www\.xtranormal\.com\/watch\/.*|dipdive\.com\/media\/.*|dipdive\.com\/member\/.*\/media\/.*|dipdive\.com\/v\/.*|.*\.dipdive\.com\/media\/.*|.*\.dipdive\.com\/v\/.*|www\.whitehouse\.gov\/photos-and-video\/video\/.*|www\.whitehouse\.gov\/video\/.*|wh\.gov\/photos-and-video\/video\/.*|wh\.gov\/video\/.*|www\.hulu\.com\/watch.*|www\.hulu\.com\/w\/.*|hulu\.com\/watch.*|hulu\.com\/w\/.*|.*crackle\.com\/c\/.*|www\.fancast\.com\/.*\/videos|www\.funnyordie\.com\/videos\/.*|www\.funnyordie\.com\/m\/.*|funnyordie\.com\/videos\/.*|funnyordie\.com\/m\/.*|www\.vimeo\.com\/groups\/.*\/videos\/.*|www\.vimeo\.com\/.*|vimeo\.com\/m\/#\/featured\/.*|vimeo\.com\/groups\/.*\/videos\/.*|vimeo\.com\/.*|vimeo\.com\/m\/#\/featured\/.*|www\.ted\.com\/talks\/.*\.html.*|www\.ted\.com\/talks\/lang\/.*\/.*\.html.*|www\.ted\.com\/index\.php\/talks\/.*\.html.*|www\.ted\.com\/index\.php\/talks\/lang\/.*\/.*\.html.*|.*nfb\.ca\/film\/.*|www\.thedailyshow\.com\/watch\/.*|www\.thedailyshow\.com\/full-episodes\/.*|www\.thedailyshow\.com\/collection\/.*\/.*\/.*|movies\.yahoo\.com\/movie\/.*\/video\/.*|movies\.yahoo\.com\/movie\/.*\/trailer|movies\.yahoo\.com\/movie\/.*\/video|www\.colbertnation\.com\/the-colbert-report-collections\/.*|www\.colbertnation\.com\/full-episodes\/.*|www\.colbertnation\.com\/the-colbert-report-videos\/.*|www\.comedycentral\.com\/videos\/index\.jhtml\?.*|www\.theonion\.com\/video\/.*|theonion\.com\/video\/.*|wordpress\.tv\/.*\/.*\/.*\/.*\/|www\.traileraddict\.com\/trailer\/.*|www\.traileraddict\.com\/clip\/.*|www\.traileraddict\.com\/poster\/.*|www\.escapistmagazine\.com\/videos\/.*|www\.trailerspy\.com\/trailer\/.*\/.*|www\.trailerspy\.com\/trailer\/.*|www\.trailerspy\.com\/view_video\.php.*|www\.atom\.com\/.*\/.*\/|fora\.tv\/.*\/.*\/.*\/.*|www\.spike\.com\/video\/.*|www\.gametrailers\.com\/video\/.*|gametrailers\.com\/video\/.*|www\.koldcast\.tv\/video\/.*|www\.koldcast\.tv\/#video:.*|techcrunch\.tv\/watch.*|techcrunch\.tv\/.*\/watch.*|mixergy\.com\/.*|video\.pbs\.org\/video\/.*|www\.zapiks\.com\/.*|tv\.digg\.com\/diggnation\/.*|tv\.digg\.com\/diggreel\/.*|tv\.digg\.com\/diggdialogg\/.*|www\.trutv\.com\/video\/.*|www\.nzonscreen\.com\/title\/.*|nzonscreen\.com\/title\/.*|app\.wistia\.com\/embed\/medias\/.*|https:\/\/app\.wistia\.com\/embed\/medias\/.*|www\.godtube\.com\/featured\/video\/.*|godtube\.com\/featured\/video\/.*|www\.godtube\.com\/watch\/.*|godtube\.com\/watch\/.*|www\.tangle\.com\/view_video.*|mediamatters\.org\/mmtv\/.*|www\.clikthrough\.com\/theater\/video\/.*|espn\.go\.com\/video\/clip.*|espn\.go\.com\/.*\/story.*|abcnews\.com\/.*\/video\/.*|abcnews\.com\/video\/playerIndex.*|washingtonpost\.com\/wp-dyn\/.*\/video\/.*\/.*\/.*\/.*|www\.washingtonpost\.com\/wp-dyn\/.*\/video\/.*\/.*\/.*\/.*|www\.boston\.com\/video.*|boston\.com\/video.*|www\.facebook\.com\/photo\.php.*|www\.facebook\.com\/video\/video\.php.*|www\.facebook\.com\/v\/.*|cnbc\.com\/id\/.*\?.*video.*|www\.cnbc\.com\/id\/.*\?.*video.*|cnbc\.com\/id\/.*\/play\/1\/video\/.*|www\.cnbc\.com\/id\/.*\/play\/1\/video\/.*|cbsnews\.com\/video\/watch\/.*|www\.google\.com\/buzz\/.*\/.*\/.*|www\.google\.com\/buzz\/.*|www\.google\.com\/profiles\/.*|google\.com\/buzz\/.*\/.*\/.*|google\.com\/buzz\/.*|google\.com\/profiles\/.*|www\.cnn\.com\/video\/.*|edition\.cnn\.com\/video\/.*|money\.cnn\.com\/video\/.*|today\.msnbc\.msn\.com\/id\/.*\/vp\/.*|www\.msnbc\.msn\.com\/id\/.*\/vp\/.*|www\.msnbc\.msn\.com\/id\/.*\/ns\/.*|today\.msnbc\.msn\.com\/id\/.*\/ns\/.*|multimedia\.foxsports\.com\/m\/video\/.*\/.*|msn\.foxsports\.com\/video.*|www\.globalpost\.com\/video\/.*|www\.globalpost\.com\/dispatch\/.*)/i},isScreencast:function(b){return Article.getScreenCastRegex().test(b)},
processNewDoc:function(b,f){var c=Sammy("body"),a={};if(b.lol1||b.lol2)throw Error("Looks like you're a bot. Epic fail.");for(key in b)/^lol\d$/.test(key)||(a[key]=b[key]);a.posted_on=Date();a.approved=!1;Article.isScreencast(b.link)?$.embedly(b.link,{urlRe:Article.getScreenCastRegex(),success:function(b){a.html=b.html;a.thumb_url=b.thumbnail_url;a.author=b.author;a.author_website=b.author_website;a.type="screencast";c.trigger("add-article",{doc:a,target:f})}}):(a.type="article",c.trigger("add-article",
{doc:a,target:f}))},beforeSave:function(b){if(!b._id){if(!/^https?:\/\//.test(b.link))b.link="http://"+b.link;b._id=b.link;delete b.link}return b}});
