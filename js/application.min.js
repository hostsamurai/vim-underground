(function(c,f){f=f||{};f.FormValidator=function(b){b.use("Mustache","mustache");var a=b.context_prototype.prototype.mustache,d={MESSAGES:{maxlength:"Too long",minlength:"Too short",required:"This field is required",pattern:"Not a valid "},validateField:function(b){var a=this,g=c(b),h=["required","maxlength","pattern"];g.hasClass("input-error")||!g.hasClass("input-valid")?c.each(h,function(b){g.data("h5-"+h[b])&&a.Messenger.appendErrorMessage(h[b],g)}):g.hasClass("input-valid")&&d.Messenger.hideInputError(g)}};
d.Messenger={formMessage:function(b,d,g){c(b).find(".submit-error, .submit-success").remove().end().find("input[type=submit]").after(a(d,g))},appendErrorMessage:function(b,a){var c=a.val().toLowerCase();switch(b){case "maxlength":if(c.length>a.attr("maxlength"))return this.showInputError(a,d.MESSAGES.maxlength),!1;break;case "required":if(c.length===0)return this.showInputError(a,d.MESSAGES.required),!1;break;case "pattern":if(a.data("h5-pattern").test(c.toLowerCase())===!1)return a.hasClass("h5-minLength")?
this.showInputError(a,d.MESSAGES.minlength):a.hasClass("h5-email")?this.showInputError(a,d.MESSAGES.pattern+"email"):this.showInputError(a,d.MESSAGES.pattern+"URL"),!1;else a.removeClass("input-error")}},showInputError:function(b,d){var c=a('<div class="error-msg">{{msg}}</div>',{msg:d});b.prev(".error-msg").length!==0?this.hideInputError(b).before(c):b.before(c)},hideInputError:function(b){return b.prev(".error-msg").remove().end()}};d.Submitter={processSubmission:function(b,a,g,h){c(a).remove(".submit-error, .submit-success");
b?(d.Messenger.formMessage(a,g,h),this.clearForm(c(a))):d.Messenger.formMessage(a,g,h)},clearForm:function(a){a.find("input:not([type=submit]), textarea").val("")}};this.helpers({validate:function(a){d.validateField(a)},successfulSubmission:function(a,b,c){d.Submitter.processSubmission(!0,a,b,c)},unSuccessfulSubmission:function(a,b,c){d.Submitter.processSubmission(!1,a,b,c)},clearForm:function(a){d.Submitter.clearForm(c(a))}})}})(jQuery,window.Sammy);
(function(c,f){f=f||{};f.Paginator=function(b,a){a||(a="paginate");b.helper(a,function(a,b){var c=this;return this.send(a,b).then(function(a){var d;d=a.rows.length==b.limit?a.rows.pop():{key:null,id:null};c.pagination(b.reference,{nextKey:d.key,nextKeyID:d.id});d=[];var f=b.reference,i=b.limit;if(f.nextIndex)i+=f.nextIndex-1,d=a.rows[0].value.slice(f.nextIndex,i);else for(f=0;f<a.rows.length;f+=1)d.push(a.rows[f].value);return{rows:d}})})}})(jQuery,window.Sammy);
(function(c){var f=c.sammy("body",function(){this.use("Mustache","ms").use("Couch","underground-git").use("FormValidator").use("Paginator","paginate");this.raise_errors=!0;this.debug=!1;this.helpers({markNew:function(b){var a=new Date,d=(new Date(Date.UTC(a.getUTCFullYear(),a.getUTCMonth(),a.getUTCDate()-3))).getTime(),e,f;c.each(b,function(a,b){f=c(b);f.length>0&&f.find(".blurb").each(function(){e=(new Date(c(this).find("date").attr("datetime"))).getTime();e>d&&c(this).append('<div class="new"></div>')})})},
toISODate:function(b){function a(a){return a<10?"0"+a:a}return b.getUTCFullYear()+"-"+a(b.getUTCMonth()+1)+"-"+a(b.getUTCDate())+"T"+a(b.getUTCHours())+":"+a(b.getUTCMinutes())+":"+a(b.getUTCSeconds())+"Z"},hideLoader:function(b){c(b).find(".loader").remove();return this},onHomepage:function(){return!/(articles|screencasts|scripts|about)$/.test(document.location.pathname)},filterResults:function(b){for(var a=[],c=0;c<b.length;c++){var e=b[c]._source;a.push({title:e.title||e.name,type:e.type,desc:e.summary||
e.description,link:/article|screencast/.test(e.type)?e._id:e.url,short_date:/article|screencast/.test(e.type)?e.posted_on.substr(0,10).replace(/-|\//g,"."):e.pushed_at.substr(0,10).replace(/-|\//g,".")})}return a},getQueryTypes:function(b){return[b.articles,b.screencasts,b.scripts].filter(function(a){if(a!==null)return a}).map(function(a){return a.toLowerCase()})},getQueryFields:function(b){return(b.articles||b.screencasts?["summary","title"]:[]).concat(b.scripts?["name","description"]:[])},formatQuery:function(b,
a,c){return{query:{filtered:{query:{query_string:{fields:b,query:a,use_dis_max:!0}},filter:{terms:{type:c}}}}}},loadBlurbs:function(b,a,d){var e=this.db.name,f={descending:!0,type:a.replace(/^\.|#/g,""),success:function(b){c(a).append(b.body).data("last-key",b.key);Hyphenator.run()}};c.extend(d,f);c.couch.db(e).list(e+"/blurbs",b,d);this.hideLoader(a);return this},validateInputs:function(b,a,d){var e=this;if(b.lol1||b.lol2)throw Error("Nice try.");c(".input-valid").length<3?(c.each([".h5-url",".h5-minLength",
"textarea"],function(a,b){e.validate(b)}),b={msg:"Sorry, your submission didn't go through. Make sure you have filled in all inputs correctly and try again.",submitClass:"submit-error"},e.unSuccessfulSubmission(a,'<p class="{{submitClass}} hyphenate">{{msg}}</p>',b)):d()}});this.after(function(){this.markNew(["#articles","#screencasts","#t-screencasts","#scripts","#t-scripts","#by-rating"])});this.get("#/",function(){this.onHomepage()&&(this.loadBlurbs("script_fragment","#scripts",{limit:12,rows:4,
cols:3,heading:"Latest Script Activity"}),this.loadBlurbs("latest_screencasts","#screencasts",{limit:6,rows:3,cols:2,trlen:28,heading:"Latest Screencasts"}));/scripts$/.test(document.location.pathname)&&this.loadBlurbs("by_rating","#by-rating",{limit:14,rows:7,cols:2,heading:"Popular Scripts"})});this.post("#/search",function(b){var a=c("header .wrapper:last .menu-link a"),d=b.getQueryTypes(b.params),e=b.getQueryFields(b.params),d=b.formatQuery(e,b.params.search,d);c.ajax({type:"POST",url:"/search",
data:{index:b.db.name,db:b.db.name,query:d},dataType:"json",success:function(c){c=b.filterResults(JSON.parse(c.body).hits.hits);b.render("search.mustache",{search:b.params.search,results:{blurbs:c}}).replace(".content").trigger("show-hide-header",{$parent:a.parents("header .wrapper"),$menu:a})},error:function(a,c,d){b.log("Didn't work!",a,c,d)}})});this.post("#/new",function(b){b.validateInputs(b.params,b.target,function(){b.send(Article.processNewDoc,b.params,b.target)})});this.post("#/contact",
function(b){var a=b.target,d;c.ajax({type:"POST",url:"/mail",data:{sender:b.params.name,email:b.params.email,subject:"Vim Underground Inquiry",message:b.params.message},dataType:"json",success:function(){d="Message sent! Thank you for your inquiry!";b.successfulSubmission(a,'<p class="{{klass}}">{{{msg}}}</p>',{klass:"submit-success",msg:d})},error:function(){d='Sorry, but your email could not be sent. You can try again or use your <a href="mailto:your@email.com">email client</a> to send the message.';
b.unSuccessfulSubmission(a,'<p class="{{klass}}">{{{msg}}}</p>',{klass:"submit-error",msg:d})}})});this.bind("show-hide-header",function(b,a){var c=a.$parent,e=a.$menu,f=parseInt(c.css("top"))<0?0:c.height()*-1+20;c.animate({top:f},"fast",function(){e.hasClass("up")?e.removeClass("up").addClass("down"):e.hasClass("down")&&e.removeClass("down").addClass("up")})});this.bind("show-more",function(b,a){var c=a.selector,e=a.options,f=e.view,g=a.parent.data("last-key"),e={limit:e.limit||15,rows:e.rows||
3,cols:e.cols||5,startkey:typeof g==="string"?g.split(",",2):g,skip:1};this.loadBlurbs(f,c,e)});this.bind("add-article",function(b,a){var c=this,e=a.target,f=a.doc,g=f.type,h;f.posted_on=c.toISODate(new Date);Article.save(f,{success:function(){h=g.capitalize()+" successfully submitted! It will appear alongside other "+g.pluralize()+" after being reviewed.";c.successfulSubmission(e,'<p class="{{klass}}">{{msg}}</p>',{klass:"submit-success",msg:h})},error:function(a,b,f){h=/Document update conflict/.test(f)?
(g==="article"?"An ":"A ")+g+" with the same URL already exists.":g.capitalize()+" not created! Please make sure you havefilled out all input fields and that they're valid before trying again. If the problem persists, feel free to contact me.";c.unSuccessfulSubmission(e,'<p class="{{klass}}">{{msg}}</p>',{klass:"submit-error",msg:h})}})});this.bind("load-validation",function(b,a){var d=c(a.form);c.h5Validate.addPatterns({minLength:/^(\w.*){5,}$/,url:RegExp("(https?|ftps?)\\://(((?:(?:[\\da-zA-Z](?:[-\\da-zA-Z]{0,61}[\\da-zA-Z])?)\\.)+(?:[a-zA-Z](?:[-\\da-zA-Z]{0,6}[\\da-zA-Z])?)\\.?))(\\:\\d+)?(/(?:[^?#\\s/]+/)*(?:[^?#\\s/]+(?:\\?[^?#\\s/]*)?(?:#[A-Za-z][\\w.:-]*)?)?)?")});
d.h5Validate({kbSelectors:"[name=title], [type=url], [type=email], [name=name], textarea",keyup:!0,errorClass:"input-error",validClass:"input-valid",debug:!1}).bind("submit",function(a){a.preventDefault()})});this.bind("run",function(){var b=this;c(".menu-link a","header").bind("click",function(a){a.preventDefault();b.trigger("show-hide-header",{$parent:c(this).parents("header .wrapper"),$menu:c(this)})});b.trigger("load-validation",{form:"form"});c(".submit").live("click",function(a){a.preventDefault();
a=c(this).parents(".wrapper").find(".menu-link a");c(".overlay").fadeIn("fast");c(this).parents("header .wrapper").length>0&&b.trigger("show-hide-header",{$parent:a.parents("header .wrapper"),$menu:a})});c("input:not([type=submit]), textarea",c(this).parent("form")[0]).live("keydown",function(){b.validate(this)});c(".close").live("click",function(a){a.preventDefault();c(".overlay").fadeOut("fast")});c(".more").live("click",function(a){if(!b.onHomepage()){a.preventDefault();var a=c(this).parent("section"),
d,e;d="#"+a.attr("id");mappings={articles:{view:"latest_articles"},"t-screencasts":{view:"latest_screencasts"},"t-scripts":{view:"script_fragment",limit:21,rows:7,cols:3},"by-rating":{view:"by_rating",limit:14,rows:7,cols:2}};e=mappings[d.replace("#","")];c(this).remove();b.trigger("show-more",{parent:a,selector:d,view:void 0,options:e})}})})});c(function(){f.run("#/")})})(jQuery);Article=Sammy("body").createModel("article");
Article.extend({getScreenCastRegex:function(){return/http:\/\/(.*youtube\.com\/watch.*|.*\.youtube\.com\/v\/.*|youtu\.be\/.*|.*\.youtube\.com\/user\/.*|.*\.youtube\.com\/.*#.*\/.*|m\.youtube\.com\/watch.*|m\.youtube\.com\/index.*|.*\.youtube\.com\/profile.*|.*justin\.tv\/.*|.*justin\.tv\/.*\/b\/.*|.*justin\.tv\/.*\/w\/.*|www\.ustream\.tv\/recorded\/.*|www\.ustream\.tv\/channel\/.*|www\.ustream\.tv\/.*|qik\.com\/video\/.*|qik\.com\/.*|qik\.ly\/.*|.*revision3\.com\/.*|.*\.dailymotion\.com\/video\/.*|.*\.dailymotion\.com\/.*\/video\/.*|www\.collegehumor\.com\/video:.*|.*twitvid\.com\/.*|www\.break\.com\/.*\/.*|vids\.myspace\.com\/index\.cfm\?fuseaction=vids\.individual&videoid.*|www\.myspace\.com\/index\.cfm\?fuseaction=.*&videoid.*|www\.metacafe\.com\/watch\/.*|www\.metacafe\.com\/w\/.*|blip\.tv\/file\/.*|.*\.blip\.tv\/file\/.*|video\.google\.com\/videoplay\?.*|.*revver\.com\/video\/.*|video\.yahoo\.com\/watch\/.*\/.*|video\.yahoo\.com\/network\/.*|.*viddler\.com\/explore\/.*\/videos\/.*|liveleak\.com\/view\?.*|www\.liveleak\.com\/view\?.*|animoto\.com\/play\/.*|dotsub\.com\/view\/.*|www\.overstream\.net\/view\.php\?oid=.*|www\.livestream\.com\/.*|www\.worldstarhiphop\.com\/videos\/video.*\.php\?v=.*|worldstarhiphop\.com\/videos\/video.*\.php\?v=.*|teachertube\.com\/viewVideo\.php.*|www\.teachertube\.com\/viewVideo\.php.*|www1\.teachertube\.com\/viewVideo\.php.*|www2\.teachertube\.com\/viewVideo\.php.*|bambuser\.com\/v\/.*|bambuser\.com\/channel\/.*|bambuser\.com\/channel\/.*\/broadcast\/.*|www\.schooltube\.com\/video\/.*\/.*|bigthink\.com\/ideas\/.*|bigthink\.com\/series\/.*|sendables\.jibjab\.com\/view\/.*|sendables\.jibjab\.com\/originals\/.*|www\.xtranormal\.com\/watch\/.*|dipdive\.com\/media\/.*|dipdive\.com\/member\/.*\/media\/.*|dipdive\.com\/v\/.*|.*\.dipdive\.com\/media\/.*|.*\.dipdive\.com\/v\/.*|www\.whitehouse\.gov\/photos-and-video\/video\/.*|www\.whitehouse\.gov\/video\/.*|wh\.gov\/photos-and-video\/video\/.*|wh\.gov\/video\/.*|www\.hulu\.com\/watch.*|www\.hulu\.com\/w\/.*|hulu\.com\/watch.*|hulu\.com\/w\/.*|.*crackle\.com\/c\/.*|www\.fancast\.com\/.*\/videos|www\.funnyordie\.com\/videos\/.*|www\.funnyordie\.com\/m\/.*|funnyordie\.com\/videos\/.*|funnyordie\.com\/m\/.*|www\.vimeo\.com\/groups\/.*\/videos\/.*|www\.vimeo\.com\/.*|vimeo\.com\/m\/#\/featured\/.*|vimeo\.com\/groups\/.*\/videos\/.*|vimeo\.com\/.*|vimeo\.com\/m\/#\/featured\/.*|www\.ted\.com\/talks\/.*\.html.*|www\.ted\.com\/talks\/lang\/.*\/.*\.html.*|www\.ted\.com\/index\.php\/talks\/.*\.html.*|www\.ted\.com\/index\.php\/talks\/lang\/.*\/.*\.html.*|.*nfb\.ca\/film\/.*|www\.thedailyshow\.com\/watch\/.*|www\.thedailyshow\.com\/full-episodes\/.*|www\.thedailyshow\.com\/collection\/.*\/.*\/.*|movies\.yahoo\.com\/movie\/.*\/video\/.*|movies\.yahoo\.com\/movie\/.*\/trailer|movies\.yahoo\.com\/movie\/.*\/video|www\.colbertnation\.com\/the-colbert-report-collections\/.*|www\.colbertnation\.com\/full-episodes\/.*|www\.colbertnation\.com\/the-colbert-report-videos\/.*|www\.comedycentral\.com\/videos\/index\.jhtml\?.*|www\.theonion\.com\/video\/.*|theonion\.com\/video\/.*|wordpress\.tv\/.*\/.*\/.*\/.*\/|www\.traileraddict\.com\/trailer\/.*|www\.traileraddict\.com\/clip\/.*|www\.traileraddict\.com\/poster\/.*|www\.escapistmagazine\.com\/videos\/.*|www\.trailerspy\.com\/trailer\/.*\/.*|www\.trailerspy\.com\/trailer\/.*|www\.trailerspy\.com\/view_video\.php.*|www\.atom\.com\/.*\/.*\/|fora\.tv\/.*\/.*\/.*\/.*|www\.spike\.com\/video\/.*|www\.gametrailers\.com\/video\/.*|gametrailers\.com\/video\/.*|www\.koldcast\.tv\/video\/.*|www\.koldcast\.tv\/#video:.*|techcrunch\.tv\/watch.*|techcrunch\.tv\/.*\/watch.*|mixergy\.com\/.*|video\.pbs\.org\/video\/.*|www\.zapiks\.com\/.*|tv\.digg\.com\/diggnation\/.*|tv\.digg\.com\/diggreel\/.*|tv\.digg\.com\/diggdialogg\/.*|www\.trutv\.com\/video\/.*|www\.nzonscreen\.com\/title\/.*|nzonscreen\.com\/title\/.*|app\.wistia\.com\/embed\/medias\/.*|https:\/\/app\.wistia\.com\/embed\/medias\/.*|www\.godtube\.com\/featured\/video\/.*|godtube\.com\/featured\/video\/.*|www\.godtube\.com\/watch\/.*|godtube\.com\/watch\/.*|www\.tangle\.com\/view_video.*|mediamatters\.org\/mmtv\/.*|www\.clikthrough\.com\/theater\/video\/.*|espn\.go\.com\/video\/clip.*|espn\.go\.com\/.*\/story.*|abcnews\.com\/.*\/video\/.*|abcnews\.com\/video\/playerIndex.*|washingtonpost\.com\/wp-dyn\/.*\/video\/.*\/.*\/.*\/.*|www\.washingtonpost\.com\/wp-dyn\/.*\/video\/.*\/.*\/.*\/.*|www\.boston\.com\/video.*|boston\.com\/video.*|www\.facebook\.com\/photo\.php.*|www\.facebook\.com\/video\/video\.php.*|www\.facebook\.com\/v\/.*|cnbc\.com\/id\/.*\?.*video.*|www\.cnbc\.com\/id\/.*\?.*video.*|cnbc\.com\/id\/.*\/play\/1\/video\/.*|www\.cnbc\.com\/id\/.*\/play\/1\/video\/.*|cbsnews\.com\/video\/watch\/.*|www\.google\.com\/buzz\/.*\/.*\/.*|www\.google\.com\/buzz\/.*|www\.google\.com\/profiles\/.*|google\.com\/buzz\/.*\/.*\/.*|google\.com\/buzz\/.*|google\.com\/profiles\/.*|www\.cnn\.com\/video\/.*|edition\.cnn\.com\/video\/.*|money\.cnn\.com\/video\/.*|today\.msnbc\.msn\.com\/id\/.*\/vp\/.*|www\.msnbc\.msn\.com\/id\/.*\/vp\/.*|www\.msnbc\.msn\.com\/id\/.*\/ns\/.*|today\.msnbc\.msn\.com\/id\/.*\/ns\/.*|multimedia\.foxsports\.com\/m\/video\/.*\/.*|msn\.foxsports\.com\/video.*|www\.globalpost\.com\/video\/.*|www\.globalpost\.com\/dispatch\/.*)/i},isScreencast:function(c){return Article.getScreenCastRegex().test(c)},
processNewDoc:function(c,f){var b=Sammy("body"),a={};if(c.lol1||c.lol2)throw Error("Looks like you're a bot. Epic fail.");for(key in c)/^lol\d$/.test(key)||(a[key]=c[key]);a.approved=!1;Article.isScreencast(c.link)?$.embedly(c.link,{urlRe:Article.getScreenCastRegex(),success:function(c){a.html=c.html;a.thumb_url=c.thumbnail_url;a.author=c.author;a.author_website=c.author_website;a.type="screencast";b.trigger("add-article",{doc:a,target:f})}}):(a.type="article",b.trigger("add-article",{doc:a,target:f}))},
beforeSave:function(c){if(!c._id){if(!/^https?:\/\//.test(c.link))c.link="http://"+c.link;c._id=c.link;delete c.link}return c}});
