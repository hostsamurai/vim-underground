(function(a,e){e=e||{};e.FormValidator=function(c){c.use("Mustache","mustache");var b=c.context_prototype.prototype.mustache,d={MESSAGES:{maxlength:"Too long",minlength:"Too short",required:"This field is required",pattern:"Not a valid "},validateField:function(b){var c=this,g=a(b),h=["required","maxlength","pattern"];g.hasClass("input-error")||!g.hasClass("input-valid")?a.each(h,function(b){g.data("h5-"+h[b])&&c.Messenger.appendErrorMessage(h[b],g)}):g.hasClass("input-valid")&&d.Messenger.hideInputError(g)}};
d.Messenger={formMessage:function(f,c,d){a(f).find(".submit-error, .submit-success").remove().end().find("input[type=submit]").after(b(c,d))},appendErrorMessage:function(b,a){var c=a.val().toLowerCase();switch(b){case "maxlength":if(c.length>a.attr("maxlength"))return this.showInputError(a,d.MESSAGES.maxlength),!1;break;case "required":if(c.length===0)return this.showInputError(a,d.MESSAGES.required),!1;break;case "pattern":if(a.data("h5-pattern").test(c.toLowerCase())===!1)return a.hasClass("h5-minLength")?
this.showInputError(a,d.MESSAGES.minlength):a.hasClass("h5-email")?this.showInputError(a,d.MESSAGES.pattern+"email"):this.showInputError(a,d.MESSAGES.pattern+"URL"),!1;else a.removeClass("input-error")}},showInputError:function(a,c){var d=b('<div class="error-msg">{{msg}}</div>',{msg:c});a.prev(".error-msg").length!==0?this.hideInputError(a).before(d):a.before(d)},hideInputError:function(a){return a.prev(".error-msg").remove().end()}};d.Submitter={processSubmission:function(b,c,g,h){a(c).remove(".submit-error, .submit-success");
b?(d.Messenger.formMessage(c,g,h),this.clearForm(a(c))):d.Messenger.formMessage(c,g,h)},clearForm:function(a){a.find("input:not([type=submit]), textarea").val("")}};this.helpers({validate:function(a){d.validateField(a)},successfulSubmission:function(a,b,c){d.Submitter.processSubmission(!0,a,b,c)},unSuccessfulSubmission:function(a,b,c){d.Submitter.processSubmission(!1,a,b,c)},clearForm:function(b){d.Submitter.clearForm(a(b))}})}})(jQuery,window.Sammy);
(function(a,e){e=e||{};e.Paginator=function(a,b){b||(b="paginate");a.helper(b,function(a,b){var c=this;return this.send(a,b).then(function(a){var d;d=a.rows.length==b.limit?a.rows.pop():{key:null,id:null};c.pagination(b.reference,{nextKey:d.key,nextKeyID:d.id});d=[];var e=b.reference,j=b.limit;if(e.nextIndex)j+=e.nextIndex-1,d=a.rows[0].value.slice(e.nextIndex,j);else for(e=0;e<a.rows.length;e+=1)d.push(a.rows[e].value);return{rows:d}})})}})(jQuery,window.Sammy);
(function(a){var e=a.sammy("body",function(){this.use("Mustache","ms").use("Couch","underground-git").use("FormValidator").use("Paginator","paginate");this.raise_errors=!0;this.debug=!1;this.helpers({markNew:function(c){var b=new Date,d=(new Date(Date.UTC(b.getUTCFullYear(),b.getUTCMonth(),b.getUTCDate()-3))).getTime(),f,e;a.each(c,function(b,c){e=a(c);e.length>0&&e.find(".blurb").each(function(){f=(new Date(a(this).find("date").attr("datetime"))).getTime();f>d&&a(this).append('<div class="new"></div>')})})},
toISODate:function(a){function b(a){return a<10?"0"+a:a}return a.getUTCFullYear()+"-"+b(a.getUTCMonth()+1)+"-"+b(a.getUTCDate())+"T"+b(a.getUTCHours())+":"+b(a.getUTCMinutes())+":"+b(a.getUTCSeconds())+"Z"},hideLoader:function(c){a(c).find(".loader").remove();return this},onHomepage:function(){return!/(articles|screencasts|scripts|about)$/.test(document.location.pathname)},loadBlurbs:function(c,b,d){var f=this.db.name,e={descending:!0,type:b.replace(/^\.|#/g,""),success:function(c){a(b).append(c.body).data("last-key",
c.key);Hyphenator.run()}};a.extend(d,e);a.couch.db(f).list(f+"/blurbs",c,d);this.hideLoader(b);return this},validateInputs:function(c,b,d){var f=this;if(c.lol1||c.lol2)throw Error("Nice try.");a(".input-valid").length<3?(a.each([".h5-url",".h5-minLength","textarea"],function(a,b){f.validate(b)}),c={msg:"Sorry, your submission didn't go through. Make sure you have filled in all inputs correctly and try again.",submitClass:"submit-error"},f.unSuccessfulSubmission(b,'<p class="{{submitClass}} hyphenate">{{msg}}</p>',
c)):d()}});this.after(function(){this.markNew(["#articles","#screencasts","#t-screencasts","#scripts","#t-scripts","#by-rating"])});this.get("#/",function(){this.onHomepage()&&(this.loadBlurbs("script_fragment","#scripts",{limit:12,rows:4,cols:3,heading:"Latest Script Activity"}),this.loadBlurbs("latest_screencasts","#screencasts",{limit:6,rows:3,cols:2,trlen:28,heading:"Latest Screencasts"}));/scripts$/.test(document.location.pathname)&&this.loadBlurbs("by_rating","#by-rating",{limit:14,rows:7,cols:2,
heading:"Popular Scripts"})});this.post("#/new",function(a){a.validateInputs(a.params,a.target,function(){a.send(Article.processNewDoc,a.params,a.target)})});this.post("#/contact",function(c){var b=c.target,d;a.ajax({type:"POST",url:"/mail",data:{sender:c.params.name,email:c.params.email,subject:"Vim Underground Inquiry",message:c.params.message},dataType:"json",success:function(){d="Message sent! Thank you for your inquiry!";c.successfulSubmission(b,'<p class="{{klass}}">{{{msg}}}</p>',{klass:"submit-success",
msg:d})},error:function(){d='Sorry, but your email could not be sent. You can try again or use your <a href="mailto:your@email.com">email client</a> to send the message.';c.unSuccessfulSubmission(b,'<p class="{{klass}}">{{{msg}}}</p>',{klass:"submit-error",msg:d})}})});this.bind("show-hide-header",function(a,b){var d=b.$parent,f=b.$menu,e=parseInt(d.css("top"))<0?0:-50;d.animate({top:e},"fast",function(){f.hasClass("up")?f.removeClass("up").addClass("down"):f.hasClass("down")&&f.removeClass("down").addClass("up")})});
this.bind("show-more",function(a,b){var d=b.selector,f=b.options,e=f.view,g=b.parent.data("last-key");f={limit:f.limit||15,rows:f.rows||3,cols:f.cols||5,startkey:typeof g==="string"?g.split(",",2):g,skip:1};this.loadBlurbs(e,d,f)});this.bind("add-article",function(a,b){var d=this,e=b.target,i=b.doc,g=i.type,h;i.posted_on=d.toISODate(new Date);Article.save(i,{success:function(){h=g.capitalize()+" successfully submitted! It will appear alongside other "+g.pluralize()+" after being reviewed.";d.successfulSubmission(e,
'<p class="{{klass}}">{{msg}}</p>',{klass:"submit-success",msg:h})},error:function(a,b,c){h=/Document update conflict/.test(c)?(g==="article"?"An ":"A ")+g+" with the same URL already exists.":g.capitalize()+" not created! Please make sure you havefilled out all input fields and that they're valid before trying again. If the problem persists, feel free to contact me.";d.unSuccessfulSubmission(e,'<p class="{{klass}}">{{msg}}</p>',{klass:"submit-error",msg:h})}})});this.bind("load-validation",function(c,
b){var d=a(b.form);a.h5Validate.addPatterns({minLength:/^(\w.*){5,}$/,url:RegExp("(https?|ftps?)\\://(((?:(?:[\\da-zA-Z](?:[-\\da-zA-Z]{0,61}[\\da-zA-Z])?)\\.)+(?:[a-zA-Z](?:[-\\da-zA-Z]{0,6}[\\da-zA-Z])?)\\.?))(\\:\\d+)?(/(?:[^?#\\s/]+/)*(?:[^?#\\s/]+(?:\\?[^?#\\s/]*)?(?:#[A-Za-z][\\w.:-]*)?)?)?")});d.h5Validate({kbSelectors:"[name=title], [type=url], [type=email], [name=name], textarea",keyup:!0,errorClass:"input-error",validClass:"input-valid",debug:!1}).bind("submit",function(a){a.preventDefault()})});
this.bind("run",function(){var c=this;a("#menu-link a","header").bind("click",function(b){b.preventDefault();c.trigger("show-hide-header",{$parent:a(this).parents("header"),$menu:a(this)})});c.trigger("load-validation",{form:"form"});a(".submit").live("click",function(b){b.preventDefault();b=a("#menu-link a");a(".overlay").fadeIn("fast");a(this).parents("header").length>0&&c.trigger("show-hide-header",{$parent:b.parents("header"),$menu:b})});a("input:not([type=submit]), textarea",a(this).parent("form")[0]).live("keydown",
function(){c.validate(this)});a(".close").live("click",function(b){b.preventDefault();a(".overlay").fadeOut("fast")});a(".more").live("click",function(b){if(!c.onHomepage()){b.preventDefault();b=a(this).parent("section");var d,e;d="#"+b.attr("id");mappings={articles:{view:"latest_articles"},"t-screencasts":{view:"latest_screencasts"},"t-scripts":{view:"script_fragment",limit:21,rows:7,cols:3},"by-rating":{view:"by_rating",limit:14,rows:7,cols:2}};e=mappings[d.replace("#","")];a(this).remove();c.trigger("show-more",
{parent:b,selector:d,view:void 0,options:e})}})})});a(function(){e.run("#/")})})(jQuery);Article=Sammy("body").createModel("article");
Article.extend({getScreenCastRegex:function(){return/http:\/\/(.*youtube\.com\/watch.*|.*\.youtube\.com\/v\/.*|youtu\.be\/.*|.*\.youtube\.com\/user\/.*|.*\.youtube\.com\/.*#.*\/.*|m\.youtube\.com\/watch.*|m\.youtube\.com\/index.*|.*\.youtube\.com\/profile.*|.*justin\.tv\/.*|.*justin\.tv\/.*\/b\/.*|.*justin\.tv\/.*\/w\/.*|www\.ustream\.tv\/recorded\/.*|www\.ustream\.tv\/channel\/.*|www\.ustream\.tv\/.*|qik\.com\/video\/.*|qik\.com\/.*|qik\.ly\/.*|.*revision3\.com\/.*|.*\.dailymotion\.com\/video\/.*|.*\.dailymotion\.com\/.*\/video\/.*|www\.collegehumor\.com\/video:.*|.*twitvid\.com\/.*|www\.break\.com\/.*\/.*|vids\.myspace\.com\/index\.cfm\?fuseaction=vids\.individual&videoid.*|www\.myspace\.com\/index\.cfm\?fuseaction=.*&videoid.*|www\.metacafe\.com\/watch\/.*|www\.metacafe\.com\/w\/.*|blip\.tv\/file\/.*|.*\.blip\.tv\/file\/.*|video\.google\.com\/videoplay\?.*|.*revver\.com\/video\/.*|video\.yahoo\.com\/watch\/.*\/.*|video\.yahoo\.com\/network\/.*|.*viddler\.com\/explore\/.*\/videos\/.*|liveleak\.com\/view\?.*|www\.liveleak\.com\/view\?.*|animoto\.com\/play\/.*|dotsub\.com\/view\/.*|www\.overstream\.net\/view\.php\?oid=.*|www\.livestream\.com\/.*|www\.worldstarhiphop\.com\/videos\/video.*\.php\?v=.*|worldstarhiphop\.com\/videos\/video.*\.php\?v=.*|teachertube\.com\/viewVideo\.php.*|www\.teachertube\.com\/viewVideo\.php.*|www1\.teachertube\.com\/viewVideo\.php.*|www2\.teachertube\.com\/viewVideo\.php.*|bambuser\.com\/v\/.*|bambuser\.com\/channel\/.*|bambuser\.com\/channel\/.*\/broadcast\/.*|www\.schooltube\.com\/video\/.*\/.*|bigthink\.com\/ideas\/.*|bigthink\.com\/series\/.*|sendables\.jibjab\.com\/view\/.*|sendables\.jibjab\.com\/originals\/.*|www\.xtranormal\.com\/watch\/.*|dipdive\.com\/media\/.*|dipdive\.com\/member\/.*\/media\/.*|dipdive\.com\/v\/.*|.*\.dipdive\.com\/media\/.*|.*\.dipdive\.com\/v\/.*|www\.whitehouse\.gov\/photos-and-video\/video\/.*|www\.whitehouse\.gov\/video\/.*|wh\.gov\/photos-and-video\/video\/.*|wh\.gov\/video\/.*|www\.hulu\.com\/watch.*|www\.hulu\.com\/w\/.*|hulu\.com\/watch.*|hulu\.com\/w\/.*|.*crackle\.com\/c\/.*|www\.fancast\.com\/.*\/videos|www\.funnyordie\.com\/videos\/.*|www\.funnyordie\.com\/m\/.*|funnyordie\.com\/videos\/.*|funnyordie\.com\/m\/.*|www\.vimeo\.com\/groups\/.*\/videos\/.*|www\.vimeo\.com\/.*|vimeo\.com\/m\/#\/featured\/.*|vimeo\.com\/groups\/.*\/videos\/.*|vimeo\.com\/.*|vimeo\.com\/m\/#\/featured\/.*|www\.ted\.com\/talks\/.*\.html.*|www\.ted\.com\/talks\/lang\/.*\/.*\.html.*|www\.ted\.com\/index\.php\/talks\/.*\.html.*|www\.ted\.com\/index\.php\/talks\/lang\/.*\/.*\.html.*|.*nfb\.ca\/film\/.*|www\.thedailyshow\.com\/watch\/.*|www\.thedailyshow\.com\/full-episodes\/.*|www\.thedailyshow\.com\/collection\/.*\/.*\/.*|movies\.yahoo\.com\/movie\/.*\/video\/.*|movies\.yahoo\.com\/movie\/.*\/trailer|movies\.yahoo\.com\/movie\/.*\/video|www\.colbertnation\.com\/the-colbert-report-collections\/.*|www\.colbertnation\.com\/full-episodes\/.*|www\.colbertnation\.com\/the-colbert-report-videos\/.*|www\.comedycentral\.com\/videos\/index\.jhtml\?.*|www\.theonion\.com\/video\/.*|theonion\.com\/video\/.*|wordpress\.tv\/.*\/.*\/.*\/.*\/|www\.traileraddict\.com\/trailer\/.*|www\.traileraddict\.com\/clip\/.*|www\.traileraddict\.com\/poster\/.*|www\.escapistmagazine\.com\/videos\/.*|www\.trailerspy\.com\/trailer\/.*\/.*|www\.trailerspy\.com\/trailer\/.*|www\.trailerspy\.com\/view_video\.php.*|www\.atom\.com\/.*\/.*\/|fora\.tv\/.*\/.*\/.*\/.*|www\.spike\.com\/video\/.*|www\.gametrailers\.com\/video\/.*|gametrailers\.com\/video\/.*|www\.koldcast\.tv\/video\/.*|www\.koldcast\.tv\/#video:.*|techcrunch\.tv\/watch.*|techcrunch\.tv\/.*\/watch.*|mixergy\.com\/.*|video\.pbs\.org\/video\/.*|www\.zapiks\.com\/.*|tv\.digg\.com\/diggnation\/.*|tv\.digg\.com\/diggreel\/.*|tv\.digg\.com\/diggdialogg\/.*|www\.trutv\.com\/video\/.*|www\.nzonscreen\.com\/title\/.*|nzonscreen\.com\/title\/.*|app\.wistia\.com\/embed\/medias\/.*|https:\/\/app\.wistia\.com\/embed\/medias\/.*|www\.godtube\.com\/featured\/video\/.*|godtube\.com\/featured\/video\/.*|www\.godtube\.com\/watch\/.*|godtube\.com\/watch\/.*|www\.tangle\.com\/view_video.*|mediamatters\.org\/mmtv\/.*|www\.clikthrough\.com\/theater\/video\/.*|espn\.go\.com\/video\/clip.*|espn\.go\.com\/.*\/story.*|abcnews\.com\/.*\/video\/.*|abcnews\.com\/video\/playerIndex.*|washingtonpost\.com\/wp-dyn\/.*\/video\/.*\/.*\/.*\/.*|www\.washingtonpost\.com\/wp-dyn\/.*\/video\/.*\/.*\/.*\/.*|www\.boston\.com\/video.*|boston\.com\/video.*|www\.facebook\.com\/photo\.php.*|www\.facebook\.com\/video\/video\.php.*|www\.facebook\.com\/v\/.*|cnbc\.com\/id\/.*\?.*video.*|www\.cnbc\.com\/id\/.*\?.*video.*|cnbc\.com\/id\/.*\/play\/1\/video\/.*|www\.cnbc\.com\/id\/.*\/play\/1\/video\/.*|cbsnews\.com\/video\/watch\/.*|www\.google\.com\/buzz\/.*\/.*\/.*|www\.google\.com\/buzz\/.*|www\.google\.com\/profiles\/.*|google\.com\/buzz\/.*\/.*\/.*|google\.com\/buzz\/.*|google\.com\/profiles\/.*|www\.cnn\.com\/video\/.*|edition\.cnn\.com\/video\/.*|money\.cnn\.com\/video\/.*|today\.msnbc\.msn\.com\/id\/.*\/vp\/.*|www\.msnbc\.msn\.com\/id\/.*\/vp\/.*|www\.msnbc\.msn\.com\/id\/.*\/ns\/.*|today\.msnbc\.msn\.com\/id\/.*\/ns\/.*|multimedia\.foxsports\.com\/m\/video\/.*\/.*|msn\.foxsports\.com\/video.*|www\.globalpost\.com\/video\/.*|www\.globalpost\.com\/dispatch\/.*)/i},isScreencast:function(a){return Article.getScreenCastRegex().test(a)},
processNewDoc:function(a,e){var c=Sammy("body"),b={};if(a.lol1||a.lol2)throw Error("Looks like you're a bot. Epic fail.");for(key in a)/^lol\d$/.test(key)||(b[key]=a[key]);b.approved=!1;Article.isScreencast(a.link)?$.embedly(a.link,{urlRe:Article.getScreenCastRegex(),success:function(a){b.html=a.html;b.thumb_url=a.thumbnail_url;b.author=a.author;b.author_website=a.author_website;b.type="screencast";c.trigger("add-article",{doc:b,target:e})}}):(b.type="article",c.trigger("add-article",{doc:b,target:e}))},
beforeSave:function(a){if(!a._id){if(!/^https?:\/\//.test(a.link))a.link="http://"+a.link;a._id=a.link;delete a.link}return a}});
